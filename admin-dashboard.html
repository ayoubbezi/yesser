<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BioGold eCommerce</title>
    <link rel="stylesheet" href="./assets/css/style.css">
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            background-color: #f1f1f1;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
        }
        .tab-button:hover {
            background-color: #0056b3;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: #007bff;
            outline: none;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
        }
        .table th, .table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .table th {
            background-color: #007bff;
            color: white;
        }
        .table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }
            .tab-button {
                padding: 8px 12px;
                font-size: 14px;
            }
            .form-group input, .form-group textarea, .form-group select {
                padding: 6px;
                font-size: 14px;
            }
            .btn {
                padding: 6px 12px;
                font-size: 14px;
            }
            .table th, .table td {
                padding: 8px;
                font-size: 14px;
            }
        }

        @media (min-width: 769px) {
            .dashboard-container {
                padding: 20px;
            }
            .tab-button {
                padding: 10px 20px;
                font-size: 16px;
            }
            .form-group input, .form-group textarea, .form-group select {
                padding: 10px;
                font-size: 16px;
            }
            .btn {
                padding: 8px 16px;
                font-size: 16px;
            }
            .table th, .table td {
                padding: 10px;
                font-size: 16px;
            }
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Admin Dashboard</h1>
        
        <div class="tab-container">
            <button class="tab-button active" onclick="openTab('products', event)">Products</button>
            <button class="tab-button" onclick="openTab('categories', event)">Categories</button>
            <button class="tab-button" onclick="openTab('orders', event)">Orders</button>
            <button class="tab-button" onclick="openTab('contacts', event)">Contacts</button>
            <button class="tab-button" onclick="openTab('users', event)">Users</button>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content active">
            <h2>Manage Products</h2>
            <button class="btn btn-primary" onclick="showAddProductForm()">Add New Product</button>
            
            <div id="addProductForm" style="display: none; margin-top: 20px;">
                <h3>Add New Product</h3>
                <form id="productForm">
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="price">Price:</label>
                        <input type="number" id="price" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="stock">Stock:</label>
                        <input type="number" id="stock" required>
                    </div>
                    <div class="form-group">
                        <label for="category">Category:</label>
                        <select id="category" required></select>
                    </div>
                    <div class="form-group">
                        <label for="image">Image:</label>
                        <input type="file" id="image" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-success">Save Product</button>
                </form>
            </div>

            <table class="table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
            </table>
        </div>

        <!-- Categories Tab -->
        <div id="categories" class="tab-content">
            <h2>Manage Categories</h2>
            <button class="btn btn-primary" onclick="showAddCategoryForm()">Add New Category</button>
            
            <div id="addCategoryForm" style="display: none; margin-top: 20px;">
                <h3>Add New Category</h3>
                <form id="categoryForm">
                    <div class="form-group">
                        <label for="categoryName">Name:</label>
                        <input type="text" id="categoryName" required>
                    </div>
                    <div class="form-group">
                        <label for="categoryDescription">Description:</label>
                        <textarea id="categoryDescription"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Save Category</button>
                </form>
            </div>

            <table class="table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesTableBody"></tbody>
            </table>
        </div>

        <!-- Orders Tab -->
        <div id="orders" class="tab-content">
            <h2>Manage Orders</h2>
            
            <div class="filter-container" style="margin-bottom: 20px;">
                <label for="orderStatus">Filter by Status:</label>
                <select id="orderStatus" onchange="filterOrders()">
                    <option value="">All Orders</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
            </table>
            
            <!-- Order Details Modal -->
            <div id="orderDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="background-color: white; width: 80%; max-width: 800px; margin: 50px auto; padding: 20px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
                    <h3>Order Details <span id="orderIdDisplay"></span></h3>
                    <button onclick="closeOrderDetails()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                    
                    <div class="order-details-content">
                        <div class="customer-info" style="margin-bottom: 20px;">
                            <h4>Customer Information</h4>
                            <p><strong>Name:</strong> <span id="customerName"></span></p>
                            <p><strong>Email:</strong> <span id="customerEmail"></span></p>
                            <p><strong>Phone:</strong> <span id="customerPhone"></span></p>
                            <p><strong>Address:</strong> <span id="customerAddress"></span></p>
                            <p><strong>Payment Method:</strong> <span id="paymentMethod"></span></p>
                        </div>
                        
                        <div class="order-items" style="margin-bottom: 20px;">
                            <h4>Order Items</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="orderItemsBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="order-summary" style="text-align: right;">
                            <p><strong>Subtotal:</strong> <span id="orderSubtotal"></span> TND</p>
                            <p><strong>Shipping:</strong> <span id="orderShipping">5.00</span> TND</p>
                            <p><strong>Total:</strong> <span id="orderTotal"></span> TND</p>
                        </div>
                        
                        <div class="status-update" style="margin-top: 20px;">
                            <h4>Update Status</h4>
                            <select id="statusUpdate" style="padding: 8px; margin-right: 10px;">
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button class="btn btn-primary" onclick="updateOrderStatus()">Update Status</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contacts Tab -->
        <div id="contacts" class="tab-content">
            <h2>Contact Messages</h2>
            
            <div class="filter-container" style="margin-bottom: 20px;">
                <label for="contactFilter">Filter:</label>
                <select id="contactFilter" onchange="filterContacts()">
                    <option value="all">All Messages</option>
                    <option value="unread">Unread</option>
                    <option value="read">Read</option>
                </select>
            </div>
            
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contactsTableBody"></tbody>
            </table>
            
            <!-- Contact Details Modal -->
            <div id="contactDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="background-color: white; width: 80%; max-width: 800px; margin: 50px auto; padding: 20px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
                    <h3>Message Details</h3>
                    <button onclick="closeContactDetails()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                    
                    <div class="contact-details-content">
                        <div style="margin-bottom: 20px;">
                            <p><strong>From:</strong> <span id="contactName"></span> (<span id="contactEmail"></span>)</p>
                            <p><strong>Date:</strong> <span id="contactDate"></span></p>
                            <p><strong>Status:</strong> <span id="contactStatus"></span></p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>Message:</h4>
                            <div id="contactMessage" style="padding: 15px; background-color: #f9f9f9; border-radius: 5px; white-space: pre-wrap;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button id="markAsReadBtn" class="btn btn-primary" onclick="markContactAsRead()">Mark as Read</button>
                            <button class="btn btn-danger" onclick="deleteContact()">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <h2>Manage Users</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Tab functionality
        function openTab(tabName, event) {
            const tabContents = document.getElementsByClassName('tab-content');
            const tabButtons = document.getElementsByClassName('tab-button');
            
            for (let content of tabContents) {
                content.classList.remove('active');
            }
            for (let button of tabButtons) {
                button.classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Form visibility toggles
        function showAddProductForm() {
            document.getElementById('addProductForm').style.display = 'block';
        }

        function showAddCategoryForm() {
            document.getElementById('addCategoryForm').style.display = 'block';
        }

        // Load data functions
        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:5000/api/products');
                const products = await response.json();
                const tableBody = document.getElementById('productsTableBody');
                tableBody.innerHTML = '';
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.title}</td>
                        <td>$${product.price}</td>
                        <td>${product.stock}</td>
                        <td>${product.Category ? product.Category.name : 'Uncategorized'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editProduct(${product.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('http://localhost:5000/api/categories');
                const categories = await response.json();
                const tableBody = document.getElementById('categoriesTableBody');
                const categorySelect = document.getElementById('category');
                
                // Update categories table
                tableBody.innerHTML = '';
                categories.forEach(category => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category.name}</td>
                        <td>${category.description || ''}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editCategory(${category.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteCategory(${category.id})">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Update category select in product form
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('http://localhost:5000/api/users');
                const users = await response.json();
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Form submission handlers
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('stock', document.getElementById('stock').value);
            
            const categoryId = document.getElementById('category').value;
            if (categoryId) {
                formData.append('categoryId', categoryId);
            }
            
            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                const response = await fetch('http://localhost:5000/api/products', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('Product added successfully!');
                    document.getElementById('productForm').reset();
                    document.getElementById('addProductForm').style.display = 'none';
                    loadProducts();
                } else {
                    const error = await response.json();
                    alert('Error adding product: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding product');
            }
        });

        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value
            };

            try {
                const response = await fetch('http://localhost:5000/api/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });
                
                if (response.ok) {
                    alert('Category added successfully!');
                    document.getElementById('categoryForm').reset();
                    document.getElementById('addCategoryForm').style.display = 'none';
                    loadCategories();
                } else {
                    alert('Error adding category');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding category');
            }
        });

        // Delete handlers
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`http://localhost:5000/api/products/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('Product deleted successfully!');
                        loadProducts();
                    } else {
                        alert('Error deleting product');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting product');
                }
            }
        }

        async function deleteCategory(id) {
            if (confirm('Are you sure you want to delete this category?')) {
                try {
                    const response = await fetch(`http://localhost:5000/api/categories/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('Category deleted successfully!');
                        loadCategories();
                    } else {
                        alert('Error deleting category');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting category');
                }
            }
        }

        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`http://localhost:5000/api/users/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('User deleted successfully!');
                        loadUsers();
                    } else {
                        alert('Error deleting user');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting user');
                }
            }
        }

        // Edit product functionality
        async function editProduct(id) {
            try {
                const response = await fetch(`http://localhost:5000/api/products/${id}`);
                const product = await response.json();

                // Pre-fill the form with product details
                document.getElementById('title').value = product.title;
                document.getElementById('description').value = product.description;
                document.getElementById('price').value = product.price;
                document.getElementById('stock').value = product.stock;
                document.getElementById('category').value = product.categoryId || '';

                // Show the form
                document.getElementById('addProductForm').style.display = 'block';

                // Update the form submission handler
                const productForm = document.getElementById('productForm');
                productForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const formData = new FormData();
                    formData.append('title', document.getElementById('title').value);
                    formData.append('description', document.getElementById('description').value);
                    formData.append('price', document.getElementById('price').value);
                    formData.append('stock', document.getElementById('stock').value);

                    const categoryId = document.getElementById('category').value;
                    if (categoryId) {
                        formData.append('categoryId', categoryId);
                    }

                    const imageFile = document.getElementById('image').files[0];
                    if (imageFile) {
                        formData.append('image', imageFile);
                    }

                    try {
                        const updateResponse = await fetch(`http://localhost:5000/api/products/${id}`, {
                            method: 'PUT',
                            body: formData
                        });

                        if (updateResponse.ok) {
                            alert('Product updated successfully!');
                            productForm.reset();
                            document.getElementById('addProductForm').style.display = 'none';
                            loadProducts();
                        } else {
                            const error = await updateResponse.json();
                            alert('Error updating product: ' + (error.message || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error updating product');
                    }
                };
            } catch (error) {
                console.error('Error fetching product details:', error);
                alert('Error fetching product details');
            }
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadCategories();
            loadOrders();
            loadContacts();
            loadUsers();
        });

        // Orders functionality
        let currentOrders = [];
        let currentOrderId = null;

        async function loadOrders() {
            try {
                const response = await fetch('http://localhost:5000/api/orders');
                
                if (!response.ok) {
                    // Log detailed error information
                    const errorText = await response.text();
                    console.error(`Error fetching orders: ${response.status} ${response.statusText}`);
                    console.error('Response body:', errorText);
                    
                    // Display error message in the orders table
                    const tableBody = document.getElementById('ordersTableBody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: red;">
                                <p>Error loading orders: ${response.status} ${response.statusText}</p>
                                <p>Please check the server console for more details</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Parse response as JSON
                const responseText = await response.text();
                console.log('Raw orders response:', responseText);
                
                let orders;
                try {
                    orders = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse orders response as JSON:', parseError);
                    console.error('Raw response:', responseText);
                    
                    const tableBody = document.getElementById('ordersTableBody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: red;">
                                <p>Error parsing server response</p>
                                <p>Please check the server console for more details</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                currentOrders = orders;
                displayOrders(orders);
            } catch (error) {
                console.error('Error loading orders:', error);
                
                // Show detailed error in the UI
                const tableBody = document.getElementById('ordersTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: red;">
                            <p>Error loading orders: ${error.message}</p>
                            <p>Please make sure the server is running at http://localhost:5000</p>
                        </td>
                    </tr>
                `;
            }
        }

        function displayOrders(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            
            if (orders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">No orders found</td>';
                tableBody.appendChild(row);
                return;
            }
            
            orders.forEach(order => {
                const date = new Date(order.orderDate || order.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.name}</td>
                    <td>${date}</td>
                    <td>${parseFloat(order.total).toFixed(2)} TND</td>
                    <td>
                        <span class="status-badge status-${order.status}">${order.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="viewOrderDetails(${order.id})">View</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add status badge styles if not already present
            if (!document.getElementById('status-badge-styles')) {
                const style = document.createElement('style');
                style.id = 'status-badge-styles';
                style.textContent = `
                    .status-badge {
                        padding: 5px 10px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                    }
                    .status-pending {
                        background-color: #FFC107;
                        color: #000;
                    }
                    .status-processing {
                        background-color: #2196F3;
                        color: #fff;
                    }
                    .status-shipped {
                        background-color: #9C27B0;
                        color: #fff;
                    }
                    .status-delivered {
                        background-color: #4CAF50;
                        color: #fff;
                    }
                    .status-cancelled {
                        background-color: #F44336;
                        color: #fff;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function filterOrders() {
            const statusFilter = document.getElementById('orderStatus').value;
            let filteredOrders = [...currentOrders];
            
            if (statusFilter) {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }
            
            displayOrders(filteredOrders);
        }

        async function viewOrderDetails(orderId) {
            try {
                const response = await fetch(`http://localhost:5000/api/orders/${orderId}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Error fetching order details: ${response.status} ${response.statusText}`);
                    console.error('Response body:', errorText);
                    alert(`Error fetching order details: ${response.status} ${response.statusText}`);
                    return;
                }
                
                // Parse response as JSON
                const responseText = await response.text();
                console.log(`Raw order ${orderId} details:`, responseText);
                
                let order;
                try {
                    order = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse order response as JSON:', parseError);
                    alert('Failed to parse server response. Check console for details.');
                    return;
                }
                
                currentOrderId = orderId;
                
                // Populate the modal with order details
                document.getElementById('orderIdDisplay').textContent = `#${order.id}`;
                document.getElementById('customerName').textContent = order.name;
                document.getElementById('customerEmail').textContent = order.email;
                document.getElementById('customerPhone').textContent = order.phone;
                document.getElementById('customerAddress').textContent = `${order.address}, ${order.city}, ${order.country}, ${order.postal}`;
                document.getElementById('paymentMethod').textContent = order.paymentMethod;
                
                // Set current status in the dropdown
                document.getElementById('statusUpdate').value = order.status;
                
                // Calculate and display order items
                const orderItemsBody = document.getElementById('orderItemsBody');
                orderItemsBody.innerHTML = '';
                
                // Parse items if they're stored as a string
                let items;
                try {
                    items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
                    console.log(`Parsed order items:`, items);
                } catch (itemsError) {
                    console.error('Error parsing order items:', itemsError);
                    console.error('Raw items data:', order.items);
                    items = [];
                    orderItemsBody.innerHTML = `<tr><td colspan="4" style="color:red">Error parsing order items</td></tr>`;
                }
                
                let subtotal = 0;
                if (items && items.length > 0) {
                    items.forEach(item => {
                        const itemPrice = parseFloat(item.price) || 0;
                        const itemQuantity = parseInt(item.quantity) || 1;
                        const itemTotal = itemPrice * itemQuantity;
                        subtotal += itemTotal;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.name}</td>
                            <td>${parseFloat(item.price).toFixed(2)} TND</td>
                            <td>${item.quantity}</td>
                            <td>${itemTotal.toFixed(2)} TND</td>
                        `;
                        orderItemsBody.appendChild(row);
                    });
                }
                
                // Display totals
                document.getElementById('orderSubtotal').textContent = subtotal.toFixed(2);
                document.getElementById('orderTotal').textContent = parseFloat(order.total).toFixed(2);
                
                // Show the modal
                document.getElementById('orderDetailsModal').style.display = 'block';
            } catch (error) {
                console.error('Error fetching order details:', error);
                alert(`Error fetching order details: ${error.message}`);
            }
        }

        function closeOrderDetails() {
            document.getElementById('orderDetailsModal').style.display = 'none';
            currentOrderId = null;
        }

        async function updateOrderStatus() {
            if (!currentOrderId) return;
            
            const newStatus = document.getElementById('statusUpdate').value;
            
            try {
                const response = await fetch(`http://localhost:5000/api/orders/${currentOrderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update order status');
                }
                
                alert('Order status updated successfully');
                closeOrderDetails();
                loadOrders();
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Error updating order status');
            }
        }

        // Contacts functionality
        let allContacts = [];
        let currentContactId = null;

        async function loadContacts() {
            try {
                const response = await fetch('http://localhost:5000/api/contacts');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Error fetching contacts: ${response.status} ${response.statusText}`);
                    console.error('Response body:', errorText);
                    
                    document.getElementById('contactsTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: red;">
                                <p>Error loading contact messages: ${response.status} ${response.statusText}</p>
                                <p>Please check the server console for more details</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const contacts = await response.json();
                allContacts = contacts;
                displayContacts(contacts);
            } catch (error) {
                console.error('Error loading contacts:', error);
                document.getElementById('contactsTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: red;">
                            <p>Error loading contact messages: ${error.message}</p>
                            <p>Please check if the server is running.</p>
                        </td>
                    </tr>
                `;
            }
        }

        function displayContacts(contacts) {
            const tableBody = document.getElementById('contactsTableBody');
            tableBody.innerHTML = '';
            
            if (contacts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center;">No contact messages found</td>
                    </tr>
                `;
                return;
            }
            
            contacts.forEach(contact => {
                const date = new Date(contact.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Truncate message for table display
                const truncatedMessage = contact.message.length > 50 
                    ? contact.message.substring(0, 50) + '...' 
                    : contact.message;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${contact.name}</td>
                    <td>${contact.email}</td>
                    <td>${truncatedMessage}</td>
                    <td>
                        <span class="badge ${contact.isRead ? 'badge-success' : 'badge-warning'}">
                            ${contact.isRead ? 'Read' : 'Unread'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="viewContactDetails(${contact.id})">View</button>
                        <button class="btn btn-danger" onclick="deleteContact(${contact.id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add badge styles if not already present
            if (!document.getElementById('badge-styles')) {
                const style = document.createElement('style');
                style.id = 'badge-styles';
                style.textContent = `
                    .badge {
                        padding: 5px 10px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 600;
                    }
                    .badge-warning {
                        background-color: #FFC107;
                        color: #000;
                    }
                    .badge-success {
                        background-color: #28a745;
                        color: #fff;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function filterContacts() {
            const filterValue = document.getElementById('contactFilter').value;
            let filteredContacts = [...allContacts];
            
            if (filterValue === 'read') {
                filteredContacts = filteredContacts.filter(contact => contact.isRead);
            } else if (filterValue === 'unread') {
                filteredContacts = filteredContacts.filter(contact => !contact.isRead);
            }
            
            displayContacts(filteredContacts);
        }

        async function viewContactDetails(contactId) {
            currentContactId = contactId;
            const contact = allContacts.find(c => c.id === contactId);
            
            if (!contact) {
                alert('Contact message not found');
                return;
            }
            
            // Format date
            const date = new Date(contact.createdAt).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Set contact details in modal
            document.getElementById('contactName').textContent = contact.name;
            document.getElementById('contactEmail').textContent = contact.email;
            document.getElementById('contactDate').textContent = date;
            document.getElementById('contactStatus').textContent = contact.isRead ? 'Read' : 'Unread';
            document.getElementById('contactMessage').textContent = contact.message;
            
            // Hide or show the "Mark as Read" button based on current status
            document.getElementById('markAsReadBtn').style.display = contact.isRead ? 'none' : 'block';
            
            // Show modal
            document.getElementById('contactDetailsModal').style.display = 'block';
        }

        function closeContactDetails() {
            document.getElementById('contactDetailsModal').style.display = 'none';
            currentContactId = null;
        }

        async function markContactAsRead() {
            if (!currentContactId) return;
            
            try {
                const response = await fetch(`http://localhost:5000/api/contacts/${currentContactId}/read`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to mark contact as read');
                }
                
                // Update contact in the array
                const contactIndex = allContacts.findIndex(c => c.id === currentContactId);
                if (contactIndex !== -1) {
                    allContacts[contactIndex].isRead = true;
                }
                
                // Update UI
                document.getElementById('contactStatus').textContent = 'Read';
                document.getElementById('markAsReadBtn').style.display = 'none';
                
                // Refresh the contacts display
                displayContacts(allContacts);
            } catch (error) {
                console.error('Error marking contact as read:', error);
                alert('Error marking contact as read');
            }
        }

        async function deleteContact(id = null) {
            // If no ID is provided, use the currentContactId from the modal
            const contactId = id || currentContactId;
            if (!contactId) return;
            
            if (!confirm('Are you sure you want to delete this contact message?')) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/contacts/${contactId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete contact message');
                }
                
                // If we're deleting from the modal, close it
                if (!id) {
                    closeContactDetails();
                }
                
                // Remove the contact from the array
                allContacts = allContacts.filter(c => c.id !== contactId);
                
                // Refresh the contacts display
                displayContacts(allContacts);
                
                alert('Contact message deleted successfully');
            } catch (error) {
                console.error('Error deleting contact message:', error);
                alert('Error deleting contact message');
            }
        }
    </script>
</body>
</html>